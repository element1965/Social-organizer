# Социальный организер — спецификация для разработки

## Общее описание

Социальный организер — это инструмент, который помогает людям быстро и прозрачно координироваться, когда кому-то нужна помощь.

Он:
- рассылает уведомления людям,
- фиксирует, кто откликнулся и на какую сумму,
- показывает, сколько уже собрано,
- хранит полную историю всех действий.

Организер не переводит деньги, не решает споры и не вмешивается в отношения людей.
Все реальные действия происходят вне системы.

> **Уточнение:** Приложение — только инструмент координации («социальный органайзер»). Создатель сбора является получателем помощи, но вся реальная помощь (переводы, действия) происходит за пределами приложения.

### Архитектура

> **Решение:** Серверная архитектура + P2P-бэкап на клиенте (Gun.js).
>
> **Серверная часть (основная):**
> - **Node.js + Fastify + Prisma + PostgreSQL** — единый язык TypeScript на фронте и бэке.
> - **tRPC** — типобезопасные API-вызовы, типы автоматически шарятся между бэком и фронтами через монорепо.
> - **BullMQ** — фоновые задачи: таймеры 12ч на доуведомления, автозакрытие циклов регулярных сборов.
> - **Хостинг:** Railway (MVP).
>
> **P2P-бэкап на клиенте (Gun.js):**
> - Gun.js используется **не как основная БД**, а как **локальный бэкап на устройстве пользователя**.
> - Каждый клиент хранит через Gun.js (IndexedDB): граф эмпатических связей (**2 уровня глубины**: мои связи + связи моих связей, до ~22,650 записей), историю и статистику активности.
> - **2 уровней достаточно** для восстановления сети — не нужно хранить 3-й уровень.
> - **Цель:** если регуляторы закроют сервер — поднимаешь новый бэкенд, клиенты переподключаются, Gun.js синхронизирует данные обратно на сервер, всё работает.
> - Gun.js relay поднимается на том же Node.js-сервере.
> - Основной источник правды — PostgreSQL. Gun.js — страховка.
>
> **UI:**
> - **Web UI:** React + shadcn/ui + Tailwind CSS — mobile-first, копируемые компоненты (Radix UI под капотом), свой уникальный стиль. UI создаётся с нуля.
> - **Mobile UI:** React Native (Expo) + NativeWind (Tailwind-синтаксис) — нативный UX на iOS/Android.
> - **Темы:** светлая и тёмная. Переключение в настройках + автоопределение по системным настройкам устройства.
> - **Звуки уведомлений:** включаются после первого пользовательского взаимодействия (ограничение браузеров). В нативном приложении — без ограничений.
> - **3D-визуализация графа связей:** react-force-graph-3d (Three.js/WebGL).
>   - **На дашборде:** красивые облака графа крутятся фоном за контентом (декоративно). Всегда WebGL, с автоопределением производительности (если устройство слабое — упрощаем детализацию).
>   - **Экран «Моя сеть»:** полноэкранный интерактивный 3D-граф с зумом — окружение пользователя на 2-3 уровня. Тап на узел → переход в профиль пользователя. Только просмотр, без добавления связей с этого экрана.
>   - **Путь рукопожатий** — при уведомлении о сборе подсвечивается цепочка «ты → A → B → создатель». Путь **вычисляется бэкендом** при отправке уведомления (BFS-обход графа) и **сохраняется** вместе с уведомлением. Клиент получает готовый путь, не вычисляет сам. Путь фиксируется как исторический факт.
>
> **Реальное время:**
> - Прогресс сбора обновляется через **polling** (запрос к серверу каждые 30-60 секунд). Секунды/минуты не критичны для этого сценария. WebSocket — оверкилл.
> - Показатель прогресса = сумма обязательств пользователей, подтвердивших намерение помочь.
>
> **Уведомления:**
> - **MVP:** только внутренние уведомления (колокольчик внутри приложения).
> - **Следующий этап:** внешние push-уведомления (FB bot messages, Telegram-бот, FCM/APNs для мобильных).
>
> **Структура проекта:** Монорепо (Turborepo):
> ```
> packages/
>   shared/        — TypeScript-типы (User, Collection, Obligation...),
>                    константы (150 связей, мин. 10 единиц, 12ч цикл),
>                    список валют, функции валидации (URL, суммы),
>                    API-клиент (общий для web и mobile)
>   api/           — Fastify бэкенд + Prisma + BullMQ + Gun.js relay
>   web/           — React SPA (shadcn/ui + Tailwind) — для FB, Telegram, веб
>   mobile/        — React Native (Expo) + NativeWind — для iOS/Android
>   graph-3d/      — Three.js визуализация:
>                    — web: react-force-graph-3d напрямую
>                    — mobile: WebView-компонент (тот же Three.js-код,
>                      взаимодействие через postMessage)
>                    — переиспользуется: логин, дашборд-фон, экран «Моя сеть»
>   i18n/          — JSON-файлы переводов (25 языков), обёртка i18next
>                    (i18next работает и в React, и в React Native)
>   fb-adapter/    — Facebook Instant Game обёртка (FBInstant SDK)
>   tg-adapter/    — Telegram Mini App обёртка (WebApp API)
> ```
>
> **Масштабирование (целевая аудитория — сотни миллионов пользователей):**
> - MVP: один PostgreSQL-сервер на Railway.
> - Рост: read replicas, Redis-кэш, шардинг БД (Citus или ручной), CDN для статики.
> - При экспоненциальном росте — бэкапы в торрент, чтобы данные были неуничтожимы.
>
> **Позиционирование для модерации:** социальный организационный инструмент, а не финансовый сервис. Никаких денежных операций внутри системы.

### Мультиплатформенность

> **Решение:** Один бэкенд + единый веб-фронтенд, который оборачивается под каждую платформу.
>
> **Фронтенд:** React (единая кодовая база).
>
> **Платформы публикации (в порядке приоритета):**
> 1. **Facebook Instant Game** (MVP) — React SPA в iframe + FBInstant SDK.
> 2. **Telegram Mini App** — React SPA + Telegram WebApp API.
> 3. **App Store / Play Market** — React Native (Expo), нативное приложение.
> 4. **GitHub Pages** — веб-версия (React SPA).
>
> **Два фронтенда, общая логика:**
> - **Web** (FB, Telegram, GitHub Pages): React SPA + shadcn/ui + Tailwind CSS.
> - **Mobile** (iOS, Android): React Native (Expo) + NativeWind (Tailwind-синтаксис для RN) + нативные компоненты.
> - **Общее:** TypeScript-типы, константы, валидация, API-клиент, i18n — в `packages/shared`.
>
> **Facebook Instant Game** — основная платформа MVP. Приложение должно быть максимально безобидным, не нарушать правил FB Gaming, гарантированно пройти модерацию.
>
> **Оптимизация для FB Instant Game:**
> - Бандл < 5MB (рекомендация Meta для быстрого старта).
> - Three.js — использовать tree-shaking, импортировать только нужные модули.
> - Планета — процедурная (шейдеры), без текстур и тяжёлых ассетов.
> - Code splitting — 3D-граф грузится лениво (lazy load), после основного UI.
> - Сжатие: gzip/brotli на все статические ресурсы.

### Авторизация

> **Решение (MVP):** Вход только через платформенные аккаунты, без SMS-верификации.
>
> - **Facebook Instant Game** — вход через Facebook Login (FBInstant SDK).
> - **Telegram Mini App** — вход через Telegram Login (WebApp API, телефон доступен автоматически).
> - **App Store** — Apple ID.
> - **Play Market** — Google Login.
>
> **Связывание аккаунтов (MVP):** Код связывания.
> - На платформе А: настройки → «Связать с другой платформой» → система генерирует 6-значный код (живёт 5 минут).
> - На платформе Б: «У меня уже есть аккаунт» → ввод кода → аккаунты связаны.
> - Бесплатно, безопасно, без SMS.
>
> **Следующий этап:** SMS-верификация телефона как дополнительный способ связывания.

---

## 1. Что такое уведомление

Уведомление — это персональное сообщение пользователю внутри системы.
Оно выглядит как сообщение в мессенджере:
- загорается колокольчик,
- пользователь открывает и видит текст.

Текст уведомления:
- Экстренный сбор: **«Запрос о срочной помощи в сумме [сумма] [валюта] от [Имя]»**
- Регулярный сбор: **«Запрос о регулярной помощи в сумме [сумма] [валюта] от [Имя]»**
- Закрытие сбора: **«Сбор закрыт»**
- Закрытие с недобором: **«Сбор закрыт с недобором в [сумма] [валюта]»**

Уведомление приходит один раз.
Никаких повторов и напоминаний не бывает.

---

## 2. Экстренная помощь (разовый сбор)

### 2.1 Создание запроса

Пользователь нажимает кнопку «Мне нужна помощь» и указывает:
- сумму, которая нужна (например, 5 000),
- валюту (₽, $, € и т.д.),
- ссылку на внешний чат (где потом всё обсуждается).

> **Уточнение:** Только эти три поля. Никаких дополнительных полей (описание, причина и т.д.) — всё обсуждается за пределами системы, в чате.
> Валюта указывается создателем сбора, чтобы люди из других стран видели сколько нужно в **его** валюте. Система валюту только отображает — не конвертирует, не обрабатывает, не хранит деньги.
>
> **Валюты:** При указании суммы доступны только **2 валюты: USD ($) и EUR (€)**. Пользователь выбирает из списка, произвольный ввод невозможен. Криптовалюты не поддерживаются.
>
> **Ссылка на чат:** Любой URL (Telegram, WhatsApp, Discord, и т.д.). Система **валидирует формат URL** при вводе — битая или невалидная ссылка не допускается. Иначе участники сбора будут ждать с моря погоды.

После этого начинается сбор.

> **Уточнение — лимит сборов:** Пользователь может иметь одновременно максимум **1 экстренный** и **1 регулярный** сбор. Других комбинаций нет (нельзя 2 экстренных или 2 регулярных одновременно).
>
> **Минимальная сумма сбора:** для любого типа сбора (экстренный или регулярный) — **10 единиц** в выбранной валюте.
>
> **Предупреждение при большой сумме:** Если сумма сбора превышает **10 000**, создатель получает предупреждение перед подтверждением: «Вам действительно жизненно важно собрать такую сумму? Вы потревожите [N] человек». Создатель должен осознанно подтвердить. Лимита на максимальную сумму нет.

### 2.2 Кого уведомляют

Организер сразу и одновременно уведомляет ограниченное количество людей, равное сумме запроса в единицах.

Пример:
- сумма запроса: 5 000
- значит уведомляется 5 000 человек

Кто именно уведомляется:
- сначала люди, которых лично добавил запросивший,
- затем люди, которых добавили они,
- дальше — по цепочке связей.

> **Уточнение:** Связь **односторонняя**. A добавляет B — это значит A знает B. B не обязан добавлять A в ответ.
> При обходе цепочки для рассылки уведомлений связи работают **во все стороны**: учитываются как исходящие (кого добавил A), так и входящие (кто добавил A). Граф связей — ненаправленный для целей рассылки.
> **Лимит 150 связей — навсегда и необратимо.** Это круг людей, с кем есть реальные эмпатические связи. Пользователь может начать хоть с **1 связи**, добавлять постепенно до 150. Но добавленного человека убрать нельзя, и больше 150 — нельзя.
> **Исключение:** если связь удалила свой аккаунт — слот освобождается (см. «Удаление аккаунта»).

Если человек получил уведомление — это его единственный шанс участвовать.

> **Уточнение:** Если в цепочке связей доступно меньше людей, чем сумма — сбор всё равно создаётся, уведомляются все доступные. Далее действует механизм доуведомления (см. 2.7).

### 2.3 Что может сделать пользователь

Получив уведомление, пользователь может:

**Взять обязательство:**
- записать сумму (минимум 10, максимум — сколько хочет) — это сумма в валюте, указанной создателем сбора,
- после этого он считается участником сбора,
- ему открывается ссылка на чат.

> **Уточнение:** Обязательство **необратимо**. Минимальная сумма обязательства — **10 единиц** в валюте сбора. Отменить или уменьшить обязательство нельзя.

> **Уточнение:** До ввода суммы пользователь видит только сумму сбора и цепочку связей («рукопожатия» — кто кого знает). Ссылка на чат **скрыта** до тех пор, пока пользователь не изъявит желание помочь, введя сумму от 1 и более.

**Закрыть уведомление:**
- это означает, что он не готов участвовать,
- повторного уведомления не будет.

**Ничего не делать:**
- через 24 часа уведомление исчезает само.

Во всех случаях факт действия (или бездействия) сохраняется в истории.

### 2.4 Что видит пользователь, который участвует

Если пользователь ввёл сумму:
- он видит общий сбор,
- видит, сколько уже собрано,
- видит, сколько ещё не хватает,
- видит, что сбор идёт в реальном времени.

Дальше он переходит в чат и там узнаёт:
- что случилось,
- как именно помочь,
- как передать деньги.

### 2.5 Что фиксирует система

> **Уточнение:** Кнопок «Я выполнил обязательство» и «Подтвердить факт помощи» — **нет**. Система фиксирует только:
> - факт, что участник вписал сумму,
> - факт, что ему открылась ссылка на чат.
>
> Дальше всё происходит за пределами системы. Система не отслеживает, помог ли человек реально.
> Создатель сбора сам решает, когда закрыть сбор вручную (см. 2.7).

Никаких споров, отказов, объяснений или арбитражей в системе не существует.
Организер ничего не решает — он только фиксирует факты.

### 2.7 Закрытие сбора и доуведомление

Закрытие сбора — **двухэтапный процесс:**

**Этап 1 — Блокировка:** Когда сумма обязательств ≥ сумма сбора — система **блокирует** возможность вписаться для остальных уведомлённых. Доуведомления прекращаются. Но сбор ещё **не закрыт**.

**Этап 2 — Закрытие:** Создатель сбора **вручную закрывает** сбор после того, как физически получил помощь. Только после этого:
- сбор считается закрытым,
- **все ранее уведомлённые** (и кто вписался, и кто не успел) получают уведомление: «Сбор закрыт».

Это просто факт, без благодарностей и комментариев.

> **Уточнение:** Если кто-то из участников не выполняет обязательство после блокировки — сбор не «переоткрывается» автоматически. Создатель **не может разблокировать** сбор. Невыполненные обязательства висят в профилях участников и видны всем. Создатель сам решает, закрывать сбор или нет.
>
> **Досрочное закрытие:** Создатель может закрыть экстренный сбор **вручную в любой момент**, даже если сумма не набрана. В этом случае все, кто заявил о готовности помочь, получают запись в статистику как **участвовавшие** (каждый — на свою заявленную сумму).
>
> **Таймаута на закрытие нет.** Создатель может не закрывать сбор сколько угодно после блокировки. Но пока сбор не закрыт — участникам **не зачтётся** помощь в статистику. Это мотивирует создателя закрыть сбор.

> **Уточнение — механизм доуведомления:**
> Каждые **12 часов**, пока сбор не закрыт, система проверяет: собрана ли нужная сумма?
> - Если нет — отправляются дополнительные уведомления **только новым людям** (не получавшим уведомление о данном сборе), дальше по сферам связей.
> - Количество доуведомлений = количество ещё не собранных единиц.
> - Пример: запрос 5 000, за 12ч собрано 4 000 → отправляется ещё 1 000 уведомлений.
> - Цикл повторяется каждые 12 часов, пока сбор не закрыт.
> - Если люди в цепочке связей закончились — **все новые пользователи**, регистрирующиеся в системе, автоматически получают уведомление об этом сборе.
> - Сбор **не имеет таймаута** — висит, пока не наберётся нужная сумма.
>
> Если сбор закрылся — все, кто получал уведомление о сборе, получают уведомление о его закрытии.

---

## 3. Регулярная помощь (ежемесячная)

### 3.1 Создание регулярного сбора

Пользователь может создать регулярный сбор, например:
«Мне нужно 2 000 в месяц».

Он указывает:
- сумму,
- валюту,
- ссылку на чат.

### 3.2 Стартовое уведомление

Организер один раз рассылает уведомления на нужное количество людей.
Дальше организер не расширяет рассылку.

Пользователь сам может:
- отправлять ссылку знакомым,
- привлекать людей напрямую.

### 3.3 Подписка

Если человек согласился:
- он оформляет регулярное обязательство,
- оно выполняется раз в месяц (например, 1 числа).

Каждый месяц:
- организер напоминает участникам,
- участники помогают вне системы,
- отмечают выполнение.

> **Уточнение:**
> - Напоминаний для регулярных сборов **нет**. Уведомление приходит **один раз** — при создании сбора.
> - Участники, которые подписались, **автоматически** считаются вписавшимися на ту же сумму каждый месяц. Заново вписывать не нужно.
> - Месячный цикл регулярного сбора **закрывается автоматически** (независимо от результата). Создателю не нужно закрывать вручную каждый месяц.
> - При закрытии цикла все вписавшиеся получают себе в **статистику** запись о помощи инициатору (каждый — на заявленную сумму).
> - Цикл регулярного сбора — **28 дней** (не календарный месяц).
> - Если сумма не собрана — все участники получают уведомление: «Сбор закрыт с недобором в [сумма] [валюта]».
> - Система не отслеживает фактическое выполнение (как и в экстренном сборе). Всё решается в чате за пределами системы.
> - Участник может **отписаться** от регулярного обязательства в любой момент.

> **Уточнение:**
> - Регулярное обязательство выполняется **всегда 1-го числа** каждого месяца. Дата не настраивается.
> - Создатель регулярного сбора может **прекратить** его в любой момент.

---

## Онбординг (первый вход)

При первом открытии приложения:

**Экран логина:**
- **3D-визуализация планеты** с «живым графом» связей вокруг неё. Планета крутится с фиксированной скоростью, узлы графа «дрожат» при прикосновении/наведении. Граф **декоративный** — случайные узлы и связи для красоты, не реальные данные. Планета — **процедурно генерируемая** (шейдеры, без текстур) для минимального размера бандла.
- Кнопка входа через платформу (FB Login / Telegram Login / Apple ID / Google).
- Язык определяется автоматически (системный язык устройства / платформы). Сменить — в настройках профиля после входа.

1. **Автоматический вход** через платформу. Имя и фото подтягиваются автоматически.
2. **Экраны онбординга** (всегда показываются, даже если пришёл по пригласительной ссылке):
3. **Обязательное добавление хотя бы 1 связи** — пользователь не попадает на дашборд, пока не добавит минимум одну связь.

### Экраны онбординга

> **Важно:** Ни один экран не должен создавать впечатление «кассы взаимопомощи», финансового сервиса или фонда. Каждый экран подчёркивает: это инструмент организации, а не денежных операций.

**Экран 1 — «Твоя сеть»**
> *Заголовок:* «У тебя есть люди, которым не всё равно»
>
> *Текст:* Это социальный организатор. Он не переводит деньги, не собирает взносы, не хранит средства. Он просто помогает людям, которые знают друг друга, быстро скоординироваться, если кому-то нужна поддержка.
>
> *Акцент:* Добавь до 150 людей, которым доверяешь — это твой личный круг. Не подписчики, не аудитория — а люди, с которыми есть настоящая связь.

**Экран 2 — «Как это работает»**
> *Заголовок:* «Один сигнал — и нужные люди узнают»
>
> *Текст:* Если кому-то из твоей сети нужна помощь — система мгновенно уведомит тех, кто может откликнуться. Уведомление приходит один раз. Никакого спама, давления или напоминаний. Система не решает за людей — она только передаёт сигнал. Все действия происходят за пределами системы — в вашем чате. Никаких денежных операций внутри.
>
> *Акцент:* Откликнуться или нет — решает каждый сам. Организатор не контролирует и не оценивает.

**Экран 3 — «Прозрачность»**
> *Заголовок:* «Всё на виду»
>
> *Текст:* Каждое действие сохраняется: кто откликнулся, кто организовал, когда и как. Профили открытые — любой может посмотреть историю любого участника. Это не рейтинг и не оценка — просто факты. Система не наказывает, не поощряет, не вмешивается. Деньги, переводы и обещания — всё это между людьми, вне системы.
>
> *Акцент:* Доверие строится на прозрачности, а не на контроле.

**Экран 4 — «Начни»**
> *Заголовок:* «Добавь первого человека»
>
> *Текст:* Организатор работает через связи между людьми. Начни с одного человека — того, кому доверяешь. Система не имеет доступа к деньгам, контактам или переписке. Только ты решаешь, кого добавить.
>
> *Действие:* [Пригласить друга по ссылке] / [Показать QR-код] / [Выбрать из друзей платформы]

### Пригласительные ссылки

> Способы добавления связей:
> - **Пригласительная ссылка** — каждый пользователь может сгенерировать персональную ссылку и отправить кому угодно.
> - **QR-код** — генерируется из пригласительной ссылки. Удобно при личной встрече — сосканировал и добавил.
> - **Выбор друзей платформы** — на FB через `chooseAsync()` (стандартный диалог Meta), на Telegram — через контакты.
>
> Во всех случаях:
> - После регистрации/принятия приглашённый **автоматически становится связью** пригласившего.
> - Связь **обоюдная** — оба тратят по 1 из своих 150 слотов.
> - Связь — навсегда и необратимо (как и все связи в системе). Исключение — удаление аккаунта.
> - **Дедупликация:** если оба пользователя отправили друг другу пригласительные ссылки — система определяет это как одну связь, тратится по 1 слоту у каждого (не по 2).

---

## Главный экран (дашборд)

При открытии приложения пользователь видит:

**Уведомления (колокольчик):**
- Счётчик непрочитанных уведомлений. При нажатии — список входящих запросов о помощи.

**Мои сборы:**
- Мой экстренный сбор (если есть): сумма, валюта, прогресс (собрано / цель), статус (активен / заблокирован).
- Мой регулярный сбор (если есть): сумма, валюта, количество подписчиков, статус текущего месяца.
- Кнопка «Мне нужна помощь» (если нет активного сбора данного типа).

**Мои обязательства:**
- Список сборов, в которых я участвую (вписал сумму): название сбора, сумма моего обязательства, статус сбора.

**Моя сеть:**
- Количество связей (из 150).
- Кнопка перехода к профилю / списку связей.

**Профиль пользователя:**

Редактируемые поля:
- **ФИО** — при регистрации берётся из платформы, можно редактировать вручную.
- **Фото** — при регистрации берётся из платформы, можно загрузить своё.
- **Телефон** — виден только пользователям в пределах **3 рукопожатий** (прямые связи, связи связей, связи связей связей). Остальным — скрыт.
- **Био** — произвольный текст о себе.

Автоматическая статистика (не редактируется):
- Сколько раз помогал (количество сборов).
- На какую общую сумму (по каждой валюте отдельно).
- Кому помогал (список).
- Сколько раз создавал сборы.
- Сколько получил помощи (общая сумма).

**Чужой профиль (просмотр):**

При тапе на узел в графе / на имя в уведомлении / в любом списке → открывается профиль:
- **ФИО, фото, био** — видны всегда.
- **Телефон** — виден только если в пределах **3 рукопожатий**. Остальным — скрыт.
- **Статистика** (помогал/получал) — видна всегда.
- **Связи** (его список до 150) — видны всем как список.
- **Кнопка «Добавить в связи»** — если ещё не связаны и у обоих есть свободные слоты.
- **Кнопка «Игнор»** — добавить в личный игнор-лист.

**Настройки:**

- **Язык** — выбор из 25 языков (автоопределяется при входе).
- **Тема** — светлая / тёмная / системная.
- **Связывание аккаунтов** — генерация кода для привязки другой платформы.
- **Игнор-лист** — управление списком заигнорированных.
- **Звуки уведомлений** — вкл/выкл.
- **Размер шрифта** — стандартный / увеличенный.
- **Удаление аккаунта** — с подтверждением.

---

## 4. История и открытость

### 4.1 Что хранится в системе

Система хранит всю активность:
- кто кого пригласил,
- кому и когда пришло уведомление,
- кто участвовал,
- кто сколько обязался,
- кто выполнил обязательства,
- когда сборы открывались и закрывались.

Ничего не удаляется.

### 4.2 Публичность

В профиле каждого пользователя видно:
- все его обязательства,
- суммы,
- кому и когда он помогал,
- историю его участия,
- его связи («рукопожатия»).

Реестр не анонимный.
Все пользователи — реальные, подтверждённые людьми, которые их знают.

> **Уточнение:** Профиль **публичный** — его видят все пользователи системы, включая связи («рукопожатия»). Любой пользователь может зайти на профиль любого другого человека в системе.

> **Уточнение — вход в систему (MVP):**
> - MVP стартует на **Facebook Instant Game**, далее — Telegram Mini App, App Store, Play Market (см. «Мультиплатформенность»).
> - Пользователь добавляет связи через: **пригласительные ссылки**, **выбор друзей платформы** (FB `chooseAsync`, Telegram контакты).
> - Максимум **150 связей**, необратимо (кроме случая удаления аккаунта связи).

---

## 5. Чего в системе нет

В системе нет:
- денег,
- переводов,
- рейтингов,
- наказаний,
- арбитражей,
- повторных уведомлений,
- давления на пользователя.

Организер — это инструмент координации, а не контроля.

> **Уточнение — игнор-лист:** Пользователь может добавить другого участника в **личный игнор**. Это означает:
> - он не получает уведомления о сборах этого участника,
> - этот участник не получает уведомления о его сборах.
> Игнор двусторонний по эффекту, но приватный — другие пользователи не видят чужие игнор-листы.
> Игнор **можно снять** в любой момент.

---

## 6. Специальные профили

В системе есть **2 специальных профиля**: **Автор** и **Разработчик**.

Особенности:
- У каждого — **незакрываемый ежемесячный сбор** (вечный, не прекращается).
- Сбор **без лимита суммы** (обычный лимит не действует).
- **Каждый новый пользователь** получает уведомление об этих сборах **на 3-й день** после регистрации.
- Уведомление **ничем не отличается** от обычного уведомления о регулярном сборе. Можно проигнорировать / закрыть как любое другое.
- В остальном профили работают как обычные — видна статистика, связи и т.д.

> Это модель поддержки проекта. Участие добровольное, как и во всех сборах.

---

## 7. Удаление аккаунта

Пользователь может **полностью удалить** свой аккаунт в любой момент. Это его выбор.

При удалении:
- **Профиль становится «серым»** — имя заменяется на «Удалённый пользователь», фото убирается, био/телефон очищаются. Профиль остаётся видимым в системе, но неактивным (серая аватарка).
- **Связи остаются в графе как полноценные узлы** — все референтные связи удалённого пользователя **сохраняются** в графе. Слоты у связанных пользователей **не освобождаются**. Граф не теряет структуру.
- **Удалённый пользователь остаётся связующим звеном** — его ячейка в графе продолжает работать как узел для связи других пользователей с их эмпатическими кругами. Это **не просто историческая запись** — это полноценный транзитный узел графа. BFS-обход продолжает проходить через удалённого пользователя при рассылке уведомлений. Удалённый пользователь просто **перестаёт принимать участие**: не получает уведомлений, не может вписаться в сборы, не может создавать сборы.
- Исторические записи об участии в сборах **сохраняются** с пометкой «удалённый пользователь».
- **Непогашенные обязательства аннулируются** — сумма вычитается из прогресса сбора.
- Активные собственные сборы — предполагается, что пользователь закроет/прекратит их перед удалением.

> Связи удалённого пользователя остаются в графе не как исторические факты, а как полноценные связи. Удалённый пользователь — это связующее звено (узел) для связи других пользователей с его эмпатическими кругами. Он просто перестаёт принимать участие. Граф — это запись реальных отношений, и удаление аккаунта не должно разрушать структуру сети.

---

## 8. Ключевая логика (коротко)

- Уведомление приходит один раз.
- Либо участвуешь, либо нет.
- Никаких напоминаний.
- Никаких оправданий.
- Вся история сохраняется.
- Все решения принимают люди, не система.

> **Уточнение — интерфейс:**
> UI мультиязычный — **25 самых используемых языков** с момента запуска.
> Реализация: **i18next** + JSON-файлы переводов. Интерфейсных строк ~200-300 — переводятся вручную, AI не нужен.
>
> **Таймзоны:** Все таймеры (12ч доуведомление, 24ч истечение, 28-дневный цикл) считаются по **UTC на сервере**. Клиент конвертирует в локальное время пользователя только при отображении.

---

## Открытые вопросы

### OQ-1: Формат Facebook-приложения и доступ к друзьям

**Проблема:** Пользователь хочет видеть всех своих FB-друзей в приложении, чтобы выбрать 150 связей. Но:
- **Facebook Instant Games API** (`getConnectedPlayersAsync`) возвращает только друзей, **уже играющих в это приложение** (за 90 дней). Полный список друзей недоступен.
- **Graph API** `/me/friends` возвращает только друзей, **давших разрешение этому приложению**. Полный список тоже недоступен.
- С 1 августа 2025 Meta ввела **Zero Permissions (NEZP)** — ещё больше ограничивает данные.
- **Web Games на Facebook закрываются к 30 сентября 2026.**

**Решение:** Используем **Facebook Instant Game** с `FBInstant.context.chooseAsync()` — стандартный диалог Meta для выбора друзей/приглашения. Дополнительно — персональные ссылки-приглашения.

**План миграции с FB Web Games (закрытие 30.09.2026):** Благодаря мультиплатформенной архитектуре — к моменту закрытия Web Games уже будут работать Telegram Mini App, мобильные приложения и веб-версия. Миграция пользователей через привязку к номеру телефона — аккаунт переносится автоматически.

**Остаётся уточнить:**
- Достаточно ли chooseAsync для выбора 150 связей (диалог может иметь лимиты)?
- Как именно показывать связи в UI, если полные данные друзей (имена, фото) ограничены NEZP?

**Статус:** частично решён.

### OQ-2: Визуализация 3D-графа при сотнях миллионов узлов ✅

**Решение:**
- **Красивые облака** — глобальный фон из кластеров/облаков (декоративный, не интерактивный на уровне отдельных узлов).
- **Срез графа** — рендерим только окружение пользователя на 2-3 уровня глубины (до ~3K узлов — легко для Three.js).
- **Путь рукопожатий** — при получении уведомления о сборе подсвечивается цепочка «ты → A → B → создатель» внутри этого среза.
- Остальной граф **не рендерим** — только облака как фон.

**Статус:** решён.

### OQ-3: Безопасность связывания аккаунтов без SMS ✅

**Решение:** Код связывания.
- На платформе А: настройки → «Связать с другой платформой» → система генерирует 6-значный код (живёт 5 минут).
- На платформе Б: «У меня уже есть аккаунт» → ввод кода → аккаунты связаны.
- Бесплатно, безопасно, просто.
- SMS-верификация телефона — следующий этап.

**Статус:** решён.

### OQ-4: Добавление в связи существующего пользователя

**Проблема:** Пригласительная ссылка / QR-код работают для новых пользователей. Как добавить в связи человека, который уже зарегистрирован в системе?

**Возможные решения:**
- Поиск по имени внутри системы + «запрос на связь» (оба должны подтвердить, т.к. связь обоюдная).
- Только через пригласительную ссылку / QR-код — даже для существующих (ссылка определяет что оба уже в системе и просто создаёт связь).
- Комбинация обоих способов.

**Статус:** открыт — ответ позже.

### OQ-5: Нормализация количества уведомлений по валютам

**Проблема:** Количество уведомляемых = сумма сбора в единицах валюты. Но валюты имеют разную стоимость:
- 5 000 JPY ≈ $33 → уведомляется 5 000 человек
- 5 000 USD ≈ $5 000 → тоже уведомляется 5 000 человек
- 5 000 KWD ≈ $16 000 → тоже 5 000 человек

Формула работает по-разному для разных валют. Нужна ли нормализация (например, всё приводить к USD-эквиваленту), или это осознанное упрощение?

**Статус:** открыт — ответ позже.
